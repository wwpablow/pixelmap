<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="åƒç´ å°äººæ—…æ¸¸åœ°å›¾ - è®°å½•å’Œæœ‹å‹ä¸€èµ·æ—…è¡Œçš„ç¾å¥½å›å¿†">
    <title>åƒç´ æ—…è¡Œåœ°å›¾ âœ¨</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="map.css">
</head>
<body>
    <!-- å°äººé€‰æ‹©é¢æ¿ -->
    <div id="character-panel">
        <div class="panel-header">
            <h2>ğŸ® æˆ‘çš„å°ä¼™ä¼´</h2>
            <p class="hint">æ‹–æ‹½å°äººåˆ°åœ°å›¾ä¸Š</p>
        </div>
        <div class="character-list">
            <div class="character-item" draggable="true" data-character="ZZ" data-name="ZZ">
                <img src="assets/ZZ.png" alt="ZZ">
                <span>ZZ</span>
            </div>
            <div class="character-item" draggable="true" data-character="xp" data-name="xp">
                <img src="assets/xp.png" alt="xp">
                <span>xp</span>
            </div>
            <div class="character-item" draggable="true" data-character="lan" data-name="lan">
                <img src="assets/lan.png" alt="lan">
                <span>lan</span>
            </div>
            <div class="character-item" draggable="true" data-character="zy" data-name="zy">
                <img src="assets/zy.png" alt="zy">
                <span>zy</span>
            </div>
            <div class="character-item" draggable="true" data-character="xi" data-name="æ›¦">
                <img src="assets/xi.png" alt="xi">
                <span>xi</span>
            </div>
             <div class="character-item" draggable="true" data-character="wwski" data-name="wwski">
                <img src="assets/wwski.png" alt="wwski">
                <span>ww</span>
            </div>
            <div class="character-item" draggable="true" data-character="cc" data-name="cc3">
                <img src="assets/cc.png" alt="cc">
                <span>cc</span>
            </div>
            <div class="character-item" draggable="true" data-character="gugu" data-name="å’•å’•">
                <img src="assets/gugu.png" alt="å’•å’•">
                <span>å’•å’•</span>
            </div>
            <div class="character-item" draggable="true" data-character="ww" data-name="WW">
                <img src="assets/ww.png" alt="WW">
                <span>WW</span>
            </div>
            <div class="character-item" draggable="true" data-character="jenna" data-name="Jenna">
                <img src="assets/wuwu.png" alt="jenna">
                <span>Jenna</span>
            </div>
            <div class="character-item" draggable="true" data-character="yej" data-name="å¶å§">
                <img src="assets/yej.png" alt="å¶å§">
                <span>å¶å§</span>
            </div>
        </div>
        <div class="panel-footer">
            <button id="clear-all-btn" class="action-btn danger">ğŸ—‘ï¸ æ¸…ç©ºåœ°å›¾</button>
        </div>
    </div>

    <!-- æ‹–æ‹½æç¤ºè¦†ç›–å±‚ -->
    <div id="drop-overlay">
        <div class="drop-hint">ğŸ“ æ¾å¼€æ”¾ç½®å°äºº</div>
    </div>

    <!-- åœ°ç‚¹å‘½åå¼¹çª— -->
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“ æ·»åŠ æ—…è¡Œè®°å¿†</h3>
            <div class="form-group">
                <label>åœ°ç‚¹åç§°</label>
                <input type="text" id="location-name" placeholder="ä¾‹å¦‚ï¼šä¸å†»æ²³ğŸ‚">
            </div>
            <div class="form-group">
                <label>æ—…è¡Œæ—¥æœŸ</label>
                <input type="date" id="trip-date">
            </div>
            <div class="form-group">
                <label>ä¸€å¥è¯è®°å½•</label>
                <input type="text" id="trip-note" placeholder="ä¾‹å¦‚ï¼šè¶…çº§å†·ä½†æ˜¯å¾ˆå¼€å¿ƒï¼">
            </div>
            <div class="modal-buttons">
                <button id="cancel-btn" class="action-btn">å–æ¶ˆ</button>
                <button id="confirm-btn" class="action-btn primary">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘/åˆ é™¤å¼¹çª— -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>âœï¸ ç¼–è¾‘æ—…è¡Œè®°å¿†</h3>
            <div class="form-group">
                <label>åœ°ç‚¹åç§°</label>
                <input type="text" id="edit-location-name">
            </div>
            <div class="form-group">
                <label>æ—…è¡Œæ—¥æœŸ</label>
                <input type="date" id="edit-trip-date">
            </div>
            <div class="form-group">
                <label>ä¸€å¥è¯è®°å½•</label>
                <input type="text" id="edit-trip-note">
            </div>
            <div class="modal-buttons">
                <button id="delete-marker-btn" class="action-btn danger">ğŸ—‘ï¸ åˆ é™¤</button>
                <button id="save-edit-btn" class="action-btn primary">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æœç´¢åœ°ç‚¹ -->
    <div id="search-panel">
        <div id="geocoder"></div>
        <!-- åˆ é™¤æœç´¢æç¤ºæ¡† -->
    </div>

    <div id="map"></div>

    <script>
    // ============ åˆå§‹åŒ– Mapbox ============
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3VtbWVycnJyciIsImEiOiJjbHA0bXJvbGswMnpuMmtwZzRrcTRqenM0In0.ZPiR8wC-kcNix7JPZ40T8Q'; 

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/summerrrrr/cmj9n574y003w01sr0ryw8m9e',
        center: [116.4074, 39.9042], // åŒ—äº¬
        zoom: 4
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // ============ åœ°ç‚¹æœç´¢ï¼ˆMapbox Geocoderï¼‰ ============
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'æœç´¢åŸå¸‚æˆ–åœ°ç‚¹ï¼Œä¾‹å¦‚ï¼šæ—¥ç…§å¸‚',
        language: 'zh-CN',
        limit: 5
    });
    geocoder.addTo('#geocoder');

    geocoder.on('result', (e) => {
        const center = e.result && e.result.center;
        if (!center) return;
        map.flyTo({
            center,
            zoom: Math.max(map.getZoom(), 9),
            essential: true
        });
        // åˆ é™¤æœç´¢æç¤ºæ¶ˆæ¯ä»£ç 
    });

    geocoder.on('error', () => {
        // åˆ é™¤æœç´¢æç¤ºæ¶ˆæ¯ä»£ç 
    });

    // ============ æ•°æ®ç®¡ç† ============
    const STORAGE_KEY = 'pixelMapMarkers';
    let markers = []; // å­˜å‚¨æ‰€æœ‰æ ‡è®° { id, character, name, coordinates, locationName, date, note, markerInstance }
    let currentDragData = null;
    let editingMarkerId = null;

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
    function loadMarkers() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return [];
            }
        }
        return [];
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    function saveMarkers() {
        const dataToSave = markers.map(m => ({
            id: m.id,
            character: m.character,
            name: m.name,
            coordinates: m.coordinates,
            locationName: m.locationName,
            date: m.date,
            note: m.note
        }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
    }

    // ç”Ÿæˆå”¯ä¸€ID
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ============ åˆ›å»ºåœ°å›¾æ ‡è®° ============
    function createMarker(data) {
        const el = document.createElement('div');
        el.className = 'map-marker';
        el.innerHTML = `<img src="assets/${data.character}.png" alt="${data.name}">`;
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        const popupContent = `
            <div class="marker-popup">
                <h3>${data.locationName || 'æœªå‘½ååœ°ç‚¹'}</h3>
                <div class="popup-info">
                    <span class="friend-tag">ğŸ‘¤ ${data.name}</span>
                    ${data.date ? `<span class="date-tag">ğŸ“… ${data.date}</span>` : ''}
                </div>
                ${data.note ? `<p class="note">"${data.note}"</p>` : ''}
                <button class="edit-btn" data-id="${data.id}">âœï¸ ç¼–è¾‘</button>
            </div>
        `;

        const popup = new mapboxgl.Popup({ offset: 25, closeButton: true })
            .setHTML(popupContent);

        const marker = new mapboxgl.Marker({
            element: el,
            anchor: 'bottom',
            draggable: true
        })
        .setLngLat(data.coordinates)
        .setPopup(popup)
        .addTo(map);

        // æ‹–æ‹½ç»“æŸåæ›´æ–°åæ ‡
        marker.on('dragend', () => {
            const lngLat = marker.getLngLat();
            const markerData = markers.find(m => m.id === data.id);
            if (markerData) {
                markerData.coordinates = [lngLat.lng, lngLat.lat];
                saveMarkers();
            }
        });

        // å¼¹çª—æ‰“å¼€æ—¶ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
        popup.on('open', () => {
            setTimeout(() => {
                const editBtn = document.querySelector(`.edit-btn[data-id="${data.id}"]`);
                if (editBtn) {
                    editBtn.onclick = () => openEditModal(data.id);
                }
            }, 10);
        });

        return marker;
    }

    // ============ æ‹–æ‹½åŠŸèƒ½ ============
    const characterItems = document.querySelectorAll('.character-item');
    const dropOverlay = document.getElementById('drop-overlay');
    const mapContainer = document.getElementById('map');

    characterItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            currentDragData = {
                character: item.dataset.character,
                name: item.dataset.name
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(currentDragData));
            item.classList.add('dragging');
            
            // åˆ›å»ºæ‹–æ‹½å›¾åƒ
            const dragImg = item.querySelector('img').cloneNode();
            dragImg.style.width = '60px';
            dragImg.style.height = '60px';
            document.body.appendChild(dragImg);
            e.dataTransfer.setDragImage(dragImg, 30, 60);
            setTimeout(() => dragImg.remove(), 0);
        });

        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            dropOverlay.classList.remove('active');
            currentDragData = null;
        });
    });

    // åœ°å›¾æ‹–æ‹½äº‹ä»¶
    mapContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropOverlay.classList.add('active');
    });

    mapContainer.addEventListener('dragleave', (e) => {
        if (!mapContainer.contains(e.relatedTarget)) {
            dropOverlay.classList.remove('active');
        }
    });

    mapContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        dropOverlay.classList.remove('active');

        if (!currentDragData) return;

        // è·å–åœ°å›¾ä¸Šçš„åæ ‡
        const rect = mapContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const lngLat = map.unproject([x, y]);

        // æ‰“å¼€å‘½åå¼¹çª—
        openNameModal(lngLat, currentDragData);
    });

    // ============ å¼¹çª—æ§åˆ¶ ============
    const nameModal = document.getElementById('name-modal');
    const editModal = document.getElementById('edit-modal');
    let pendingMarkerData = null;

    function openNameModal(lngLat, dragData) {
        pendingMarkerData = {
            id: generateId(),
            character: dragData.character,
            name: dragData.name,
            coordinates: [lngLat.lng, lngLat.lat]
        };
        
        document.getElementById('location-name').value = '';
        document.getElementById('trip-date').value = '';
        document.getElementById('trip-note').value = '';
        nameModal.classList.add('active');
    }

    document.getElementById('confirm-btn').addEventListener('click', () => {
        if (!pendingMarkerData) return;

        pendingMarkerData.locationName = document.getElementById('location-name').value || 'æœªå‘½ååœ°ç‚¹';
        pendingMarkerData.date = document.getElementById('trip-date').value;
        pendingMarkerData.note = document.getElementById('trip-note').value;

        // åˆ›å»ºæ ‡è®°
        pendingMarkerData.markerInstance = createMarker(pendingMarkerData);
        markers.push(pendingMarkerData);
        saveMarkers();

        nameModal.classList.remove('active');
        pendingMarkerData = null;
    });

    document.getElementById('cancel-btn').addEventListener('click', () => {
        nameModal.classList.remove('active');
        pendingMarkerData = null;
    });

    // ç¼–è¾‘å¼¹çª—
    function openEditModal(markerId) {
        const markerData = markers.find(m => m.id === markerId);
        if (!markerData) return;

        editingMarkerId = markerId;
        document.getElementById('edit-location-name').value = markerData.locationName || '';
        document.getElementById('edit-trip-date').value = markerData.date || '';
        document.getElementById('edit-trip-note').value = markerData.note || '';
        
        // å…³é—­popup
        markerData.markerInstance.getPopup().remove();
        
        editModal.classList.add('active');
    }

    document.getElementById('save-edit-btn').addEventListener('click', () => {
        const markerData = markers.find(m => m.id === editingMarkerId);
        if (!markerData) return;

        markerData.locationName = document.getElementById('edit-location-name').value || 'æœªå‘½ååœ°ç‚¹';
        markerData.date = document.getElementById('edit-trip-date').value;
        markerData.note = document.getElementById('edit-trip-note').value;

        // æ›´æ–°å¼¹çª—å†…å®¹
        const popupContent = `
            <div class="marker-popup">
                <h3>${markerData.locationName}</h3>
                <div class="popup-info">
                    <span class="friend-tag">ğŸ‘¤ ${markerData.name}</span>
                    ${markerData.date ? `<span class="date-tag">ğŸ“… ${markerData.date}</span>` : ''}
                </div>
                ${markerData.note ? `<p class="note">"${markerData.note}"</p>` : ''}
                <button class="edit-btn" data-id="${markerData.id}">âœï¸ ç¼–è¾‘</button>
            </div>
        `;
        markerData.markerInstance.getPopup().setHTML(popupContent);

        saveMarkers();
        editModal.classList.remove('active');
        editingMarkerId = null;
    });

    document.getElementById('delete-marker-btn').addEventListener('click', () => {
        const markerData = markers.find(m => m.id === editingMarkerId);
        if (!markerData) return;

        markerData.markerInstance.remove();
        markers = markers.filter(m => m.id !== editingMarkerId);
        saveMarkers();

        editModal.classList.remove('active');
        editingMarkerId = null;
    });

    // æ¸…ç©ºæ‰€æœ‰æ ‡è®°
    document.getElementById('clear-all-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ ‡è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            markers.forEach(m => m.markerInstance.remove());
            markers = [];
            saveMarkers();
        }
    });

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    [nameModal, editModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });

    // ============ åˆå§‹åŒ–åŠ è½½ ============
    map.on('load', () => {
        const savedMarkers = loadMarkers();
        savedMarkers.forEach(data => {
            data.markerInstance = createMarker(data);
            markers.push(data);
        });
    });
    </script>
</body>
</html>


